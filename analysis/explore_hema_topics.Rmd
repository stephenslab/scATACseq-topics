---
title: Visualize topics inferred from hematopoietic single-cell ATAC-seq data
author: Peter Carbonetto
output:
  workflowr::wflow_html:
    toc: no
    theme: readable
    highlight: textmate
    self_contained: no
---

This is a brief exploration of topics inferred from the single-cell
ATAC-seq data of Buenrostro *et al* (2018).

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load some packages used in the analysis below, and set the seed.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
set.seed(1)
```

Load the fragment counts and cell population labels.

```{r load-data}
load("data/Buenrostro_2018_counts.RData")
samples <- transform(samples,label = factor(label))
```

Load the $k = 11$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS(file.path("output/Buenrostro_2018/unbinarized",
                         "fit-Buenrostro2018-scd-ex-k=11.rds"))$fit
```

Perform PCA on the topic proportions, and use these PCs to define
clusters.

```{r identify-clusters}
pca <- prcomp(poisson2multinom(fit)$L)$x
x   <- rep("A",nrow(pca))
pc1 <- pca[,1]
pc2 <- pca[,2]
pc3 <- pca[,3]
pc4 <- pca[,4]
pc5 <- pca[,5]
pc6 <- pca[,6]
pc8 <- pca[,8]
x[pc1 < 0.1]  <- "B"
x[pc2 < -0.2] <- "C"
x[pc3 > 0.35] <- "pDC"
x[pc3 < -0.1 & pc4 < 0.05] <- "GMP"
x[pc4 > 0.55] <- "CLP"
x[pc5 < -0.25 & pc6 < -0.25] <- "mono"
x[pc8 > 0.35] <- "U"
samples$cluster <- factor(x)
```

The most distinct clusters (e.g., pDC) closely correspond to the
Buenrostro *et al* (2018) FACS cell populations.

```{r compare-clusters-to-population-labels}
table(samples$label,samples$cluster)
```

The projection of the cells onto the top 4 PCs (omitting the "unknown"
cluster) is reminiscent of the hematopoietic differentiation
trajectory.  To make this more clear, I plotted the cell types using
the same colours used in Buenrostro *et al* (2018).

```{r, fig.height=2.75, fig.width=7, message=FALSE}
facs_colors <- c("skyblue",     # CLP
                 "gold",        # CMP
                 "orange",      # GMP
                 "forestgreen", # HSC
                 "turquoise",   # LMPP
                 "firebrick",   # MEP
                 "orangered",   # mono
                 "greenyellow", # MPP
                 "orchid",      # pDC
                 "gray")        # unknown
rows <- which(samples$cluster != "U")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p1 <- pca_plot(fit2,pcs = 1:2,fill = samples[rows,"label"]) +
  scale_fill_manual(values = facs_colors) +
  labs(fill = "cell type")
p2 <- pca_plot(fit2,pcs = 3:4,fill = samples[rows,"label"]) +
  scale_fill_manual(values = facs_colors) +
  labs(fill = "cell type")
plot_grid(p1,p2)
```

The Structure plot summarizes the topic proportions in the 8
clusters. Cluster A contains mainly HSC and MPP cells; cluster C is
comprised mainly of CMP and MEP cells; and cluster B is the most
heterogeneous and contains LMPP, GMP and CMP cell types.

```{r structure-plot, fig.height=1.75, fig.width=7.5, message=FALSE}
topic_colors <- c("greenyellow",
                  "yellow",      # CMP
                  "gold",        # CMP
                  "orchid",      # pDC
                  "orangered",   # mono
                  "firebrick",   # MEP
                  "orange",      # GMP
                  "skyblue",     # CLP
                  "gray",        # U
                  "forestgreen", # HSC + MPP
                  "turquoise")   # LMPP
topics <- c(2,9,8,4,5,3,11,1,7,6,10)
p3 <- structure_plot(poisson2multinom(fit),topics = topics,
                     colors = topic_colors[topics],
                     grouping = samples$cluster,gap = 20,
                     num_threads = 4,verbose = FALSE)
print(p3)
```

The A, B, C and GMP clusters contain additional substructure that
might be worth a closer look.

Interestingly, there are two large subclusters in cluster A that don't
map to the two main cell types in this cluster:

```{r, fig.height=2.5, fig.width=3.5, message=FALSE}
rows <- which(samples$cluster == "A")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p4   <- pca_plot(fit2,fill = samples$label[rows,drop = FALSE]) +
  scale_fill_manual(values = facs_colors,drop = FALSE) +
  labs(fill = "cell type")
print(p4)
```

There is also some interesting substructure in cluster C, and in
particular a somewhat distinct subcluster of MEP cells:

```{r, fig.height=2.5, fig.width=3.5, message=FALSE}
rows <- which(samples$cluster == "C")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p5   <- pca_plot(fit2,fill = samples$label[rows,drop = FALSE]) +
  scale_fill_manual(values = facs_colors,drop = FALSE) +
  labs(fill = "cell type")
print(p5)
```
