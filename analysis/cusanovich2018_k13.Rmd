---
title: "Topic modeling analysis of Cusanovich et al (2018) data with k = 13 topics"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we examine the structure inferred from the $k = 13$ topic model
fit the Cusanovich *et al* (2018) sci-ATAC-seq data.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
```

Load the sample meta-data:

```{r load-data}
tissues <-
  c("Testes_62016","BoneMarrow_62016","BoneMarrow_62216","HeartA_62816",
    "Liver_62016","Kidney_62016","SmallIntestine_62816","LargeIntestineA_62816",
	"LargeIntestineB_62816","Lung1_62216","Lung2_62216",
	"Spleen_62016","Thymus_62016","PreFrontalCortex_62216","Cerebellum_62216",
	"WholeBrainA_62216","WholeBrainA_62816")
load("data/Cusanovich_2018/processed_data/Cusanovich_2018_metadata_only.RData")
samples <- transform(samples,
                     tissue.replicate = factor(tissue.replicate,tissues))
```
					 
Next load the $k = 13$ binomial topic model fit.

```{r load-fit}
load("output/Cusanovich_2018/binom-fit-cusanovich2018-k=13.RData")
round(colSums(fit_binom$L),digits = 2)
```

This Structure plot shows the cells arranged by tissue. Note that
replicates were collected for four of the tissues (bone marrow, lung,
small intestine, whole brain) in a second mouse. 

```{r structure-plot-1, fig.height=2.5, fig.width=8, message=FALSE}
set.seed(1)
topic_colors <- c("gold","royalblue","red","sienna","limegreen",
                  "plum","tomato","purple","cyan","forestgreen",
                  "darkblue","darkorange","lightgray")
topics <- c(10,5,7,11,8,9,1,2,4,3,12,6,13)
p1 <- structure_plot(fit_binom,grouping = samples$tissue.replicate,gap = 30,
                     n = 4000,perplexity = 30,colors = topic_colors,
					 topics = topics,verbose = FALSE)
print(p1)
```

Reassuringly, the replicates show a very similar distribution of
topics. Also reassuringly, some tissues are clearly distinguished by
the topics (e.g., thymus), and similar tissues (e.g., small and large
intenstine) share topics.

```{r tissue-sample-sizes}
table(samples$tissue.replicate)
```

```{r structure-plot-for-paper-1, echo=FALSE}
ggsave("plots/structure_plot_by_tissue_cusanovich.eps",p1,
       height = 2.25,width = 9)
```

In this next Structure plot, we arrange the cells by the "major
clusters" identified by
[Cusanovich *et al*](https://doi.org/10.1016/j.cell.2018.06.052) (they
used the Louvain community detection algorithm implemented in Seurat
to identify these clusters).

```{r structure-plot-2, fig.height=2.5, fig.width=8, message=FALSE}
cell_types <-
  c("Cardiomyocytes",
    "Astrocytes",
    "Oligodendrocytes",
    "Hepatocytes",
    "Podocytes",
    "Endothelial cells",
    "Neurons",
    "Purkinje cells",
    "Cerebellar granule cells",
    "T cells",
    "B cells",
    "Other immune cells",
    "Erythroblasts",
    "Sperm",
    "Proximal tubule",
    "cluster 18",
    "Pneumocytes",
    "Enterocytes",
    "Hematopoietic progenitors",
    "Collisions",
    "Unknown")
x <- samples$cell_label
x[x == "Activated B cells"] <- "B cells"
x[x == "Immature B cells"] <- "B cells"
x[x == "Ex. neurons CPN"] <- "Neurons"
x[x == "Ex. neurons SCPN"] <- "Neurons"
x[x == "Ex. neurons CThPN"] <- "Neurons"
x[x == "SOM+ Interneurons"] <- "Neurons"
x[x == "Inhibitory neurons"] <- "Neurons"
x[x == "Regulatory T cells"] <- "T cells"
x[x == "Endothelial I cells"] <- "Endothelial cells"
x[x == "Endothelial II cells"] <- "Endothelial cells"
x[x == "Endothelial I (glomerular)"] <- "Endothelial cells"
x[x == "Proximal tubule S3"] <- "Proximal tubule"
x[x == "Type I pneumocytes"] <- "Pneumocytes"
x[x == "Type II pneumocytes"] <- "Pneumocytes"
x[x == "Alveolar macrophages"] <- "Macrophages"
x[x == "Loop of henle"] <- "cluster 18"
x[x == "Distal convoluted tubule"] <- "cluster 18"
x[x == "Collecting duct"] <- "cluster 18"
x[x == "DCT/CD"] <- "cluster 18"
x[x == "Monocytes"] <- "Other immune cells"
x[x == "Dendritic cells"] <- "Other immune cells"
x[x == "Macrophages"] <- "Other immune cells"
x[x == "Microglia"] <- "Other immune cells"
x[x == "NK cells"] <- "Other immune cells"
samples <- transform(samples,
                     cell_label = factor(x,cell_types))
set.seed(1)
p2 <- structure_plot(fit_binom,grouping = samples$cell_label,gap = 30,n = 4000,
                     perplexity = 30,topics = topics,colors = topic_colors,
					 verbose = FALSE)
print(p2)
```

Clearly, the topics capture much of the high-level structure
identified by the community detection algorithm.

```{r cell-type-sample-sizes}
table(samples$cell_label)
```

```{r structure-plot-for-paper-2, echo=FALSE}
ggsave("plots/structure_plot_by_cluster_cusanovich.eps",p2,
       height = 2.25,width = 9)
```

[cusanovich-2018]: https://doi.org/10.1016/j.cell.2018.06.052
