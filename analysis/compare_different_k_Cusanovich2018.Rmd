---
title: "Compare results from different number of topics (k) in Cusanovich2018 data"
author: "Kaixuan Luo"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

Here we examine and compare the topic modeling results for the 
scATAC-seq dataset from the mouse single-cell atlas paper 
[Cusanovich *et al* (2018)](scATACseq_data_Cusanovich2018.html)

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that will be used to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(ggplot2)
library(cowplot)
library(Matrix)
library(tools)
library(reshape2)
library(dplyr)
library(RColorBrewer)
source("code/plots.R")
```

colors
```{r colors}
col_13 <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c",
            "#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928",
            "gray")

col_15 <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c",
            "#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","gold1",
            "#b15928", "black", "gray")

# from https://stackoverflow.com/questions/9563711/r-color-palettes-for-many-data-classes/41230685#41230685
col_25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

col_20 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "brown"
)

# from https://stackoverflow.com/questions/15282580/how-to-generate-a-number-of-most-distinctive-colors-in-r
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]
col_74 <- unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

# colors for tissues as shown in the original paper
colors_tissues <- c("darkblue",    # BoneMarrow
                    "gray30",      # Cerebellum
                    "red",         # Heart
                    "springgreen", # Kidney
                    "brown",       # LargeIntestine
                    "purple",      # Liver
                    "deepskyblue", # Lung
                    "black",       # PreFrontalCortex
                    "darkgreen",   # SmallIntestine
                    "plum",        # Spleen
                    "gold",        # Testes
                    "darkorange",  # Thymus
                    "gray")        # WholeBrain

```


## Load Cusanovich 2018 mouse scATAC-seq data

### Load the data and Poisson NMF model fit
Load the data
```{r load-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Cusanovich_2018/processed_data/"
load(file.path(data.dir, "Cusanovich_2018.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
rm(counts)
```

About the samples:

The study measured single cell chromatin accessibility for 17 samples 
spanning 13 different tissues in 8-week old mice.
```{r samples}
cat(nrow(samples), "samples (cells). \n")
```

Tissues:
```{r samples-tissues}
samples$tissue <- factor(samples$tissue, levels = c("Heart", "Liver", "Thymus", 
                                                    "Spleen","Lung",  "Kidney", 
                                                    "LargeIntestine", "SmallIntestine", "Testes", 
                                                    "BoneMarrow", 
                                                    "Cerebellum", "PreFrontalCortex", "WholeBrain"))
cat(length(levels(samples$tissue)), "tissues. \n")
table(samples$tissue)
```

Cell types labels:
```{r samples-cells}
samples$cell_label <- as.factor(samples$cell_label)
cat(length(levels(samples$cell_label)), "cell types \n")
table(samples$cell_label)
```

## Structure plots using different number of $k$

The structure plots below summarize the topic proportions in the samples grouped by different tissues.

### $k = 13$
```{r load-fit-k13}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-scd-ex-k=13.rds"))$fit
fit_multinom <- poisson2multinom(fit)
```

```{r structure-plot-k13, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)

colors_topics <- col_13
idx_selected_samples <- sample(nrow(fit_multinom$L),4000)

p.structure <- structure_plot(select(fit_multinom,loadings = idx_selected_samples),
                              grouping = samples[idx_selected_samples, "tissue"],
                              n = Inf,gap = 40, perplexity = 50,
                              topics = 1:13,colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

Count the number of tissues has membership > 1% in each topic 
```{r}
topic_proportions <- fit_multinom$L
topic_appearance <- as.matrix((fit_multinom$L > 0.01) + 0)
samples_topics <- samples[,c("cell", "tissue", "cell_label")]
samples_topics <- cbind(samples_topics, topic_appearance)
samples_topics$num_topics <- rowSums(topic_appearance)

freq_table_tissue_in_topic <- matrix(0, nrow = length(levels(samples_topics$tissue)), ncol = ncol(topic_appearance))
rownames(freq_table_tissue_in_topic) <- levels(samples_topics$tissue)
colnames(freq_table_tissue_in_topic) <- colnames(topic_appearance)

for ( k in 1:ncol(topic_appearance)) {
  freq_table_tissue_in_topic[,k] <- table(samples_topics[samples_topics[,paste0("k",k)] == 1, "tissue"])
}
print(freq_table_tissue_in_topic)

```

### $k = 20$
```{r load-fit-k20}
k <- 20
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
fit <- readRDS(sprintf("%s/fit-Cusanovich2018-scd-ex-k=%d.rds", fit.dir, k))$fit
fit_multinom <- poisson2multinom(fit)
```

```{r structure-plot-k20, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)

colors_topics <- col_20
idx_selected_samples <- sample(nrow(fit_multinom$L),4000)

p.structure <- structure_plot(select(fit_multinom,loadings = idx_selected_samples),
                              grouping = samples[idx_selected_samples, "tissue"],
                              n = Inf,gap = 40, perplexity = 50,
                              topics = 1:k,colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

Count the number of tissues has membership > 5% in each topic 
```{r count-tissues-topics}
topic_proportions <- fit_multinom$L
topic_appearance <- as.matrix((fit_multinom$L > 0.05) + 0)
samples_topics <- samples[,c("cell", "tissue", "cell_label")]
samples_topics <- cbind(samples_topics, topic_appearance)
samples_topics$count_topics <- rowSums(topic_appearance)

freq_table_tissue_in_topic <- matrix(0, nrow = length(levels(samples_topics$tissue)), ncol = ncol(topic_appearance))
rownames(freq_table_tissue_in_topic) <- levels(samples_topics$tissue)
colnames(freq_table_tissue_in_topic) <- colnames(topic_appearance)

for ( k in 1:ncol(topic_appearance)) {
  freq_table_tissue_in_topic[,k] <- table(samples_topics[samples_topics[,paste0("k",k)] == 1, "tissue"])
}
print(freq_table_tissue_in_topic)

```

Plot the distribution of tissues in each topic, ordered by entropy in each topic
```{r}
# calculates the Shannon entropy, following Tatsle & Wierman (2007)
# from https://rdrr.io/rforge/agrmt/src/R/entropy.R
entropy <- function(v) {
  v <- v/sum(v)    # normalizing the vector
  log2v <- log2(v) # set log2(-Inf) as 0
  log2v[log2v == -Inf] <- 0
  return(-sum(v * log2v))
}

```

```{r barplot-tissues-topics-k20, fig.width=8, fig.height=3}
freq_table_tissue_in_topic.df <- melt(freq_table_tissue_in_topic)
colnames(freq_table_tissue_in_topic.df) <- c("tissue", "topic", "freq")

topic_entropy <- sort(apply(freq_table_tissue_in_topic, 2, entropy))

freq_table_tissue_in_topic.df$topic <- factor(freq_table_tissue_in_topic.df$topic, levels = names(topic_entropy))

# stacked barplot for the counts of tissues by clusters
p.barplot <- ggplot(freq_table_tissue_in_topic.df, aes(fill=tissue, y=freq, x=topic)) + 
  geom_bar(position="fill", stat="identity") +
  theme_classic() + xlab("Topic") + ylab("Proportion of cells") +
  scale_fill_manual(values = colors_tissues) +
  guides(fill=guide_legend(ncol=2)) +
  theme(
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  )

print(p.barplot)

```

```{r heatmap-tissues-topics-k20,  eval=FALSE, fig.width=7, fig.height=5}
# Simple heatmap of the proportions by hierarchical clustering

create_simple_heatmap(freq_table_tissue_in_topic, normalize_by = "row", title = "proportions normalized by rows (each row sums to 1)", cluster_rows = TRUE)

create_simple_heatmap(freq_table_tissue_in_topic, normalize_by = "column", title = "proportions normalized by columns (each column sums to 1)", cluster_rows = TRUE)

```

```{r piechart-celllables-k20, eval=FALSE, fig.width=8, fig.height=8}
# Cells with membership > 5% in topic k20
data <- as.data.frame(table(samples_topics[samples_topics$k20 == 1, "cell_label"]))
colnames(data) <- c("cell_label", "count")
data <- data[order(data$count, decreasing = T), ]
data$cell_label <- factor(data$cell_label, levels = unique(data$cell_label))

# piechart
p_pie <- ggplot(data, aes(x="", y=count, fill=cell_label)) +
  geom_bar(stat="identity", width=1, color="white") +
  scale_fill_manual(values = col_74) +
  coord_polar("y", start=0) +
  ggtitle("Topic k20") +
  theme_void() # remove background, grid, numeric labels
print(p_pie)

```

Structure plot for Cerebellum, PreFrontalCortex, WholeBrain.

Merge topics with cumulative average proportion < 5%. i.e. the topics included cover > 95% of the area.
```{r structure-plot-brain-related-k20, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)

idx_selected_samples <- which(samples$tissue %in% c("Cerebellum", "PreFrontalCortex", "WholeBrain"))

fit_tissue <- select(fit_multinom,loadings = idx_selected_samples)
grouping_tissue <- as.factor(as.character(samples[idx_selected_samples, "tissue"]))

# merge topics with cumulative average proportion < 0.05
topic_mean_proportion <- sort(colMeans(fit_tissue$L))
topics_merged <- names(which(cumsum(topic_mean_proportion) < 0.05))
fit_tissue_merged <- merge_topics(fit_tissue, k = topics_merged)
colnames(fit_tissue_merged$L)[ncol(fit_tissue_merged$L)] <- "others"
colnames(fit_tissue_merged$F)[ncol(fit_tissue_merged$F)] <- "others"

colors_topics <- col_20
names(colors_topics) <- paste0("k", 1:20)
colors_topics <- colors_topics[colnames(fit_tissue_merged$L)]
colors_topics[is.na(colors_topics)] <- "gray"

p.structure <- structure_plot(fit_tissue_merged,
                              grouping = grouping_tissue,
                              n = min(3000, length(idx_selected_samples)), 
                              gap = 40, perplexity = 50,
                              topics = colnames(fit_tissue_merged$L),
                              colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

Structure plot for Heart, Lung, Kidney, Spleen.

```{r structure-plot-heart-lung-kidney-k20, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)

idx_selected_samples <- which(samples$tissue %in% c("Heart", "Lung", "Kidney", "Spleen"))

fit_tissue <- select(fit_multinom,loadings = idx_selected_samples)
grouping_tissue <- as.factor(as.character(samples[idx_selected_samples, "tissue"]))

# merge topics with cumulative average proportion < 0.05
topic_mean_proportion <- sort(colMeans(fit_tissue$L))
topics_merged <- names(which(cumsum(topic_mean_proportion) < 0.05))
fit_tissue_merged <- merge_topics(fit_tissue, k = topics_merged)
colnames(fit_tissue_merged$L)[ncol(fit_tissue_merged$L)] <- "others"
colnames(fit_tissue_merged$F)[ncol(fit_tissue_merged$F)] <- "others"

colors_topics <- col_20
names(colors_topics) <- paste0("k", 1:20)
colors_topics <- colors_topics[colnames(fit_tissue_merged$L)]
colors_topics[is.na(colors_topics)] <- "gray"

p.structure <- structure_plot(fit_tissue_merged,
                              grouping = grouping_tissue,
                              n = min(3000, length(idx_selected_samples)), 
                              gap = 40, perplexity = 50,
                              topics = colnames(fit_tissue_merged$L),
                              colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

Structure plot for Heart only.

```{r structure-plot-heart-k20, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)

idx_selected_samples <- which(samples$tissue %in% "Heart")

fit_tissue <- select(fit_multinom,loadings = idx_selected_samples)
grouping_tissue <- as.factor(as.character(samples[idx_selected_samples, "tissue"]))

# merge topics with cumulative average proportion < 0.1
topic_mean_proportion <- sort(colMeans(fit_tissue$L))
topics_merged <- names(which(cumsum(topic_mean_proportion) < 0.05))
fit_tissue_merged <- merge_topics(fit_tissue, k = topics_merged)
colnames(fit_tissue_merged$L)[ncol(fit_tissue_merged$L)] <- "others"
colnames(fit_tissue_merged$F)[ncol(fit_tissue_merged$F)] <- "others"

colors_topics <- col_20
names(colors_topics) <- paste0("k", 1:20)
colors_topics <- colors_topics[colnames(fit_tissue_merged$L)]
colors_topics[is.na(colors_topics)] <- "gray"

p.structure <- structure_plot(fit_tissue_merged,
                              grouping = grouping_tissue,
                              n = min(3000, length(idx_selected_samples)), 
                              gap = 40, perplexity = 50,
                              topics = colnames(fit_tissue_merged$L),
                              colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

### $k = 30$
```{r load-fit-k30}
k <- 30
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
fit <- readRDS(sprintf("%s/fit-Cusanovich2018-scd-ex-k=%d.rds", fit.dir, k))$fit
fit_multinom <- poisson2multinom(fit)
```

```{r structure-plot-k30, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)

colors_topics <- sample(col_74, k)
idx_selected_samples <- sample(nrow(fit$L),4000)

p.structure <- structure_plot(select(fit_multinom,loadings = idx_selected_samples),
                              grouping = samples[idx_selected_samples, "tissue"],
                              n = Inf,gap = 40, perplexity = 50,
                              topics = 1:k,colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

### $k = 35$
```{r load-fit-35}
k <- 35
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
fit <- readRDS(sprintf("%s/fit-Cusanovich2018-scd-ex-k=%d.rds", fit.dir, k))$fit
fit_multinom <- poisson2multinom(fit)
```

```{r structure-plot-k35, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)
colors_topics <- sample(col_74, k)
idx_selected_samples <- sample(nrow(fit$L),4000)

p.structure <- structure_plot(select(fit_multinom,loadings = idx_selected_samples),
                              grouping = samples[idx_selected_samples, "tissue"],
                              n = Inf,gap = 40, perplexity = 50,
                              topics = 1:k,colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```

### $k = 40$
```{r load-fit-40}
k <- 40
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
fit <- readRDS(sprintf("%s/fit-Cusanovich2018-scd-ex-k=%d.rds", fit.dir, k))$fit
fit_multinom <- poisson2multinom(fit)
```

```{r structure-plot-k40, fig.width=8, fig.height=3.5, message=FALSE}
set.seed(10)
colors_topics <- sample(col_74, k)
idx_selected_samples <- sample(nrow(fit$L),4000)

p.structure <- structure_plot(select(fit_multinom,loadings = idx_selected_samples),
                              grouping = samples[idx_selected_samples, "tissue"],
                              n = Inf,gap = 40, perplexity = 50,
                              topics = 1:k,colors = colors_topics,
                              num_threads = 8,verbose = FALSE)

print(p.structure)
```
