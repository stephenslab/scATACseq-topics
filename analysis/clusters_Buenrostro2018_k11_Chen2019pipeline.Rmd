---
title: "Clustering Buenrostro *et al* (2018) scATAC-seq data using topic proportions with K = 11"
author: Kaixuan Luo
output:
  workflowr::wflow_html:
    toc: yes
---

Here we explore the structure in the Buenrostro *et al* (2018) 
scATAC-seq data inferred from the 
multinomial topic model with $k = 11$.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```
					  
Load packages and some functions used in this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(ggplot2)
library(cowplot)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(fastTopics)
library(DT)
library(reshape)
source("code/plots.R")
```

Load the data. The counts are no longer needed at this stage of the analysis.
```{r load-binarized-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Buenrostro_2018/processed_data_Chen2019pipeline/"
load(file.path(data.dir, "Buenrostro_2018_binarized_counts.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
rm(counts)
samples$cell <- rownames(samples)
samples$label <- as.factor(samples$label)
```

Load the model fit
```{r load-fit}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Buenrostro_2018_Chen2019pipeline/binarized/"
fit <- readRDS(file.path(fit.dir, "/fit-Buenrostro2018-binarized-scd-ex-k=11.rds"))$fit
fit_multinom <- poisson2multinom(fit)
```

## Structure plots

The structure plots below summarize the topic proportions in the samples grouped by different tissues.

## Visualize by Structure plot grouped by tissues
```{r structure-plot, fig.width=7, fig.height=3, message=FALSE}
set.seed(10)
colors_topics <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c",
                   "#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99")

samples$label <- as.factor(samples$label)

p.structure.1 <- structure_plot(fit_multinom,
                     grouping = samples[, "label"], 
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)

print(p.structure.1)
```

### k-means clustering on topic proportions
Define clusters using k-means, and then create structure plot 
based on the clusters from k-means.

k-means clustering (using 15 clusters) on topic proportions
```{r structure-plot-kmeans-1, fig.width=7, fig.height=3, message=FALSE}

set.seed(10)
clusters <- factor(kmeans(fit_multinom$L,centers = 15,iter.max = 100)$cluster)
summary(clusters)

p.structure.kmeans <- structure_plot(fit_multinom,
                                     grouping = clusters,n = Inf,gap = 20,
                                     perplexity = 50,topics = 1:11,colors = colors_topics,
                                     num_threads = 4,verbose = FALSE)
print(p.structure.kmeans)
```

First do PCA on topic proportions and then do k-means clustering.
Results are the same as the results from running k-means directly on the topic proportions.
```{r structure-plot-kmeans-pca-1, fig.width=7, fig.height=3, message=FALSE}

set.seed(10)
pca <- prcomp(fit_multinom$L)$x
clusters2 <- factor(kmeans(pca,centers = 15,iter.max = 100)$cluster)
summary(clusters2)

length(which(clusters != clusters2))
```

Define clusters using k-means with $k = 20$:
k-means clustering (using 15 clusters) on topic proportions
```{r structure-plot-kmeans-20, fig.width=7, fig.height=3, message=FALSE}

set.seed(10)
clusters.20 <- factor(kmeans(fit_multinom$L,centers = 20,iter.max = 100)$cluster)
summary(clusters.20)

p.structure.kmeans <- structure_plot(fit_multinom,
                                     grouping = clusters.20,n = Inf,gap = 20,
                                     perplexity = 50,topics = 1:11,colors = colors_topics,
                                     num_threads = 4,verbose = FALSE)
print(p.structure.kmeans)
```
First do PCA on topic proportions and then do k-means clustering.
Results are again the same as the results from running k-means directly on the topic proportions.
```{r structure-plot-kmeans-pca-20, fig.width=7, fig.height=3, message=FALSE}

set.seed(10)
pca <- prcomp(fit_multinom$L)$x
clusters.20.2 <- factor(kmeans(pca,centers = 20,iter.max = 100)$cluster)
summary(clusters.20.2)

length(which(clusters.20 != clusters.20.2))

```

### Refine clusters
We then further refine the clusters based on k-means result with $k = 20$:
merge clusters 3, 4;
merge clusters 5 and 8;
merge clusters 6 and 19;
merge clusters 14 and 18;
merge clusters 16 and 20

```{r refine-clusters}
clusters.merged <- clusters.20
clusters.merged[clusters.20 %in% c(3,4)] <- 3
clusters.merged[clusters.20 %in% c(5,8)] <- 5
clusters.merged[clusters.20 %in% c(6,19)] <- 6
clusters.merged[clusters.20 %in% c(14,18)] <- 14
clusters.merged[clusters.20 %in% c(16,20)] <- 16

clusters.merged <- factor(clusters.merged, labels = paste0("c", c(1:length(unique(clusters.merged)))))
samples$cluster_kmeans <- clusters.merged
table(clusters.merged)
```

```{r refine-clusters-2, fig.width=7, fig.height=3, message=FALSE}
p.structure.refined <- structure_plot(fit_multinom,
                     grouping = clusters.merged,
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.refined)
```

Save the clustering results to an RDS file
```{r save-clusters}
out.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Buenrostro_2018_Chen2019pipeline/binarized/"
saveRDS(samples, paste0(out.dir, "/samples-clustering-Buenrostro2018.rds"))
cat("Result saved to:", paste0(out.dir, "/samples-clustering-Buenrostro2018.rds"), "\n")
samples <- readRDS(paste0(out.dir, "/samples-clustering-Buenrostro2018.rds"))
print(table(samples$cluster_kmeans))
```

## Plot the distribution of cell type labels in each cluster

```{r sample-labels}
samples$label <- as.factor(samples$label)
cat(length(levels(samples$label)), "cell labels. \n")
table(samples$label)

freq_cluster_cells <- with(samples,table(label,cluster_kmeans))
print(freq_cluster_cells)
```

Cell-type composition in each cluster:
```{r freq-cluster, fig.width=8, fig.height=3}

freq_cluster_celltype <- count(samples, vars=c("cluster_kmeans","label")) 
n_colors <- length(levels(samples$label))
colors_labels <- brewer.pal(10, "Set3")

p.barplot <- ggplot(freq_cluster_celltype, aes(fill=label, y=freq, x=cluster_kmeans)) + 
  geom_bar(position="fill", stat="identity") +
  theme_classic() + xlab("Cluster") + ylab("Proportion of cells") +
  scale_fill_manual(values = colors_labels) +
  guides(fill=guide_legend(ncol=2)) +
  theme(
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8)
  )
print(p.barplot)

```

<!-- ## PCA of the topic proportions -->

<!-- Plot PCs of the topic proportions. -->
<!-- ```{r pca-1, fig.width=7, fig.height=4.5} -->
<!-- breaks <- c(0,1,5,10,100,Inf) -->
<!-- p.pca2.1 <- pca_hexbin_plot(fit_multinom, pcs = 1:2, breaks = breaks) + guides(fill = "none") -->
<!-- p.pca2.2 <- pca_hexbin_plot(fit_multinom, pcs = 3:4, breaks = breaks) + guides(fill = "none") -->
<!-- p.pca2.3 <- pca_hexbin_plot(fit_multinom, pcs = 5:6, breaks = breaks) + guides(fill = "none") -->
<!-- p.pca2.4 <- pca_hexbin_plot(fit_multinom, pcs = 7:8, breaks = breaks) + guides(fill = "none") -->
<!-- p.pca2.5 <- pca_hexbin_plot(fit_multinom, pcs = 9:10, breaks = breaks) + guides(fill = "none") -->

<!-- plot_grid(p.pca2.1,p.pca2.2,p.pca2.3,p.pca2.4,p.pca2.5) -->
<!-- ``` -->

<!-- Layer the cell labels onto the PC plots. -->
<!-- ```{r pca-2, fig.width=9, fig.height=5} -->
<!-- p.pca3.1 <- labeled_pca_plot(fit,1:2,samples$label,font_size = 7, -->
<!--                        legend_label = "Cell labels") -->
<!-- p.pca3.2 <- labeled_pca_plot(fit,3:4,samples$label,font_size = 7, -->
<!--                        legend_label = "Cell labels") -->
<!-- p.pca3.3 <- labeled_pca_plot(fit,5:6,samples$label,font_size = 7, -->
<!--                        legend_label = "Cell labels") -->
<!-- p.pca3.4 <- labeled_pca_plot(fit,7:8,samples$label,font_size = 7, -->
<!--                        legend_label = "Cell labels") -->
<!-- p.pca3.5 <- labeled_pca_plot(fit,9:10,samples$label,font_size = 7, -->
<!--                        legend_label = "Cell labels") -->

<!-- plot_grid(p.pca3.1,p.pca3.2,p.pca3.3,p.pca3.4,p.pca3.5) -->
<!-- ``` -->




