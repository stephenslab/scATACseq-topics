---
title: "Topic modeling analysis of Buenrostro et al (2018) data with k = 10 topics"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we summarize and interpret the results from the topic modeling
analysis of the Buenrostro et al (2018) data, with $k = 10$ topics.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the count data (see [here](process_data_Buenrostro2018.html) for
details on these data and how they were prepared).

```{r load-data}
load("data/Buenrostro_2018/processed_data/Buenrostro_2018_binarized.RData")
```

Next we load the $k = 10$ multinomial topic model fit to these data,
the results of the GoM DE analysis using this topic model, and the
results of the HOMER motif enrichment analysis using the *p*-values
from the GoM DE analysis:

```{r load-results}
fit <- readRDS(
  file.path("output/Buenrostro_2018/binarized/filtered_peaks",
            "fit-Buenrostro2018-binarized-filtered-scd-ex-k=10.rds"))$fit
fit <- poisson2multinom(fit)
load(file.path("output/Buenrostro_2018/binarized/filtered_peaks",
               "de-buenrostro2018-k=10-noshrink.RData"))
homer <- readRDS(file.path("output/Buenrostro_2018/binarized/filtered_peaks",
                           "homer-buenrostro2018-k=10-noshrink.rds"))
```

Visualize the structure identified in the FACS cell populations using
a Structure plot:

```{r structure-plot, fig.height=1.75, fig.width=8, message=FALSE}
set.seed(1)
celltypes <- factor(samples$label,
                    c("pDC","CLP","LMPP","HSC","MPP","CMP","MEP","GMP",
                      "mono","UNK"))
topic_colors <- c("gold","forestgreen","orchid","red","lightgray",
                  "dimgray","orange","dodgerblue","limegreen","mediumblue")
p <- structure_plot(fit,grouping = celltypes,n = Inf,gap = 20,
                     perplexity = 70,verbose = FALSE,colors = topic_colors,
			         topics = c(5,10,8,3,4,1,6,7,2,9))
print(p)
```

```{r structure-plot-for-paper, echo=FALSE}
ggsave("plots/structure_plot_buenrostro.eps",p,height = 1.6,width = 8)
```

Comparing the topic proportions with the cell labels (provided by
FACS), we see that the topics capture chromatin accessibility patterns
characteristic of early hematopoietic progenitors (HSC, MPP; topics 2
and 9), and the four different hematopoietic cell lineages: CLPs and
LMPPs (topic 8); pDCs (topic 3); monocytes and GMPs (topics 1 and 7);
and MEPs (topic 4). Additional topics (topics 5, 6 and 10) may be
picking up other factors such as patient-specific batch effects or
tissue of origin (bone marrow or blood). Additionally, the split of
the HSC/MPP cells into two topics seems to also reflect
patient-specific batch effects, which also came up in the PCA analysis
in the original paper. We see this more clearly when we arrange the
cells by patient id and FACS cell type:

```{r structure-plot-by-sample, fig.height=2, fig.width=8, message=FALSE}
n <- nrow(samples)
x <- rep("unknown",n)
ids <- c("BM4983","BM0106","BM0828","PB1022","BM1077","BM1137","BM1214")
for (id in ids) 
  x[grepl(id,samples$name,fixed = TRUE)] <- id
samples$donor <- factor(x)
set.seed(1)
donor_and_label <- factor(paste(samples$donor,celltypes,sep = "-"))
p <- structure_plot(fit,grouping = donor_and_label,n = Inf,gap = 20,
                     perplexity = 10,verbose = FALSE,colors = topic_colors,
			         topics = c(5,10,8,3,4,1,6,7,2,9))
print(p)
```

```{r structure-plot-by-sample-for-paper, echo=FALSE}
ggsave("plots/structure_plot_by_sample_buenrostro.eps",p,
       height = 2,width = 11)
```


In the GoM DE analysis, we attempt to quantify *differential
accessibility* among topics. 

```{r de-analysis-plot, fig.height=2, fig.width=2.5, message=FALSE, warning=FALSE}
pdat <- data.frame(pval = 10^(-as.vector(de$lpval)))
p <- ggplot(pdat,aes(x = pval)) +
  geom_histogram(bins = 32,color = "white",fill = "black") +
  scale_y_continuous(breaks = seq(0,1e5,2e4)) +
  labs(x = "p-value",y = "LFCs") +
  theme_cowplot(font_size = 10)
print(p)
```

```{r de-analysis-plot-for-paper, echo=FALSE, warning=FALSE}
ggsave("plots/de_analysis_histogram_buenrostro.eps",p,height = 2.5,width = 3)
```

The issue is that individual regions rarely show significant
differences in accessibility, but a *motif enrichment analysis* of the
regions might point to interesting transcription factors common to the
more accessible regions. We performed the motif enrichment analysis
using HOMER.

First, we compile the motif enrichment *p*-values into a single table
(after removing a small number of duplicate results).

```{r compile-homer-results}
k <- 10
topics <- paste0("k",1:k)
motifs <- sort(unique(homer$k1[,"Motif Name"]))
n <- length(motifs)
homer_lpvals <- matrix(0,n,k)
rownames(homer_lpvals) <- motifs
colnames(homer_lpvals) <- topics
for (i in topics) {
  dat  <- homer[[i]]
  rows <- which(!duplicated(dat[,"Motif Name"]))
  dat  <- dat[rows,]
  rownames(dat)   <- dat[,"Motif Name"]
  homer_lpvals[,i] <- round(dat[motifs,"Log P-value"],digits = 2)
}
dat  <- homer$k1
rows <- which(!duplicated(dat[,"Motif Name"]))
dat  <- dat[rows,]
rownames(dat) <- dat[,"Motif Name"]
homer_lpvals <- cbind(dat[motifs,c("Motif Name","Consensus")],homer_lpvals)
```

```{r write-homer-results, echo=FALSE}
write.csv(homer_lpvals,"homer_buenrostro.csv",row.names = FALSE)
```

Next, plot the *p*-values for selected motifs in a tile plot:

```{r homer-tile-plot, fig.height=4, fig.width=5.75}
# Colors from colorbrewer2.org.
colors <- c("#d73027","#f46d43","#fdae61","#fee090",
            "#e0f3f8","#abd9e9","#74add1","#4575b4")
motifs <- c("Hoxc9(Homeobox)/Ainv15-Hoxc9-ChIP-Seq(GSE21812)/Homer",
            "Hoxb4(Homeobox)/ES-Hoxb4-ChIP-Seq(GSE34014)/Homer",
            "HOXA1(Homeobox)/mES-Hoxa1-ChIP-Seq(SRP084292)/Homer",
            "ERG(ETS)/VCaP-ERG-ChIP-Seq(GSE14097)/Homer",
            "EWS:ERG-fusion(ETS)/CADO_ES1-EWS:ERG-ChIP-Seq(SRA014231)/Homer",
            "Atf1(bZIP)/K562-ATF1-ChIP-Seq(GSE31477)/Homer",
            "Atf4(bZIP)/MEF-Atf4-ChIP-Seq(GSE35681)/Homer",
            "Atf7(bZIP)/3T3L1-Atf7-ChIP-Seq(GSE56872)/Homer",
            "CEBP(bZIP)/ThioMac-CEBPb-ChIP-Seq(GSE21512)/Homer",
            "CEBP:AP1(bZIP)/ThioMac-CEBPb-ChIP-Seq(GSE21512)/Homer",
            "CEBP:CEBP(bZIP)/MEF-Chop-ChIP-Seq(GSE35681)/Homer",
            "EBF2(EBF)/BrownAdipose-EBF2-ChIP-Seq(GSE97114)/Homer",
            "EBF(EBF)/proBcell-EBF-ChIP-Seq(GSE21978)/Homer",
            "EBF1(EBF)/Near-E2A-ChIP-Seq(GSE21512)/Homer",
            "ETS:E-box(ETS,bHLH)/HPC7-Scl-ChIP-Seq(GSE22178)/Homer",
            "GATA:SCL(Zf,bHLH)/Ter119-SCL-ChIP-Seq(GSE18720)/Homer",
            "Gata1(Zf)/K562-GATA1-ChIP-Seq(GSE18829)/Homer",
            "Gata2(Zf)/K562-GATA2-ChIP-Seq(GSE18829)/Homer",
            "GATA3(Zf)/iTreg-Gata3-ChIP-Seq(GSE20898)/Homer",
            "Gata4(Zf)/Heart-Gata4-ChIP-Seq(GSE35151)/Homer",
            "Gata6(Zf)/HUG1N-GATA6-ChIP-Seq(GSE51936)/Homer",
            "Tcf12(bHLH)/GM12878-Tcf12-ChIP-Seq(GSE32465)/Homer",
            "TCF4(bHLH)/SHSY5Y-TCF4-ChIP-Seq(GSE96915)/Homer",
            "Fosl2(bZIP)/3T3L1-Fosl2-ChIP-Seq(GSE56872)/Homer",
            "Fos(bZIP)/TSC-Fos-ChIP-Seq(GSE110950)/Homer",
            "Jun-AP1(bZIP)/K562-cJun-ChIP-Seq(GSE31477)/Homer",
            "JunB(bZIP)/DendriticCells-Junb-ChIP-Seq(GSE36099)/Homer")
homer_lpvals <- homer_lpvals[motifs,]
pdat <- NULL
for (i in topics) {
  pdat <- rbind(pdat,
                data.frame(motif = homer_lpvals[,"Motif Name"],
                           topic = i,
                           lpval = homer_lpvals[,i]))
}
pdat <- transform(pdat,
                  topic = factor(topic,c("k9","k2","k3","k4","k8",
                                         "k1","k7","k5","k6","k10")),
            lpval = cut(lpval,c(-Inf,-150,-100,-50,-30,-20,-10,-5,0)),
            motif = factor(motif,rev(motifs)))
p <- ggplot(pdat,aes(x = topic,y = motif,fill = lpval)) +
  geom_tile(color = "white",size = 0.5) +
  scale_fill_manual(values = colors) +
  labs(x = "",y = "") +
  theme_cowplot(font_size = 8)
print(p)
```

```{r homer-tile-plot-for-paper, echo=FALSE}
ggsave("plots/homer_tile_plot_buenrostro.eps",p,height = 4,width = 6)
```
