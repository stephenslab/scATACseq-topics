---
title: "Topic modeling analysis of Cusanovich et al (2018) kidney cells with k = 10 topics"
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add overview of the analysis here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(pathways)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("code/kidney_genes.R")
source("code/volcano_plots.R")
```

Load the binarized count data.

```{r load-data}
load("data/Cusanovich_2018/processed_data/Cusanovich_2018_Kidney.RData")
```

Load the $K = 10$ topic model fit.

```{r load-fit}
fit <- readRDS(file.path("output/Cusanovich_2018/tissues",
                         "fit-Cusanovich2018-Kidney-scd-ex-k=10.rds"))$fit
fit <- poisson2multinom(fit)
```

Load the gene-wise results obtained from the `de_analysis` of the
peaks.

```{r load-de-gene}
load(file.path("output/Cusanovich_2018/tissues",
               "de-gene-cusanovich2018-kidney-k=10.RData"))
```

This next Structure plot shows the correspondence between the topics
and the final cell-type labels from Cusanovich *et al*
("cell_label"). Some of more distinct cell-types (e.g., loop of henle,
podocytes) are captured by a single topic, Note that some of the
cell-type labels are combined to improve the Structure plot; in
particular, several of the labels that only appear once or a few times
are combined into the "Other or unknown" grouping.

```{r structure-plot-1, fig.height=2.5, fig.width=8, message=FALSE}
set.seed(1)
x <- samples$cell_label
x[x == "Activated B cells" | x == "B cells" | x == "Alveolar macrophages" |
  x == "Monocytes" | x == "NK cells" | x == "T cells" | 
  x == "Regulatory T cells" | x == "Dendritic cells" |
  x == "Macrophages"] <- "Immune cells"
x[x == "Endothelial I (glomerular)" |
  x == "Endothelial I cells"] <- "Endothelial I cells"
x[x == "Collisions" | x == "Enterocytes" | x == "Hepatocytes" |
  x == "Sperm" | x == "Type II pneumocytes" | x == "Endothelial II cells" |
  x == "Hematopoietic progenitors" | x == "Unknown"] <- "Other or unknown"
x <- factor(x,c("Collecting duct","DCT/CD","Distal convoluted tubule",
                "Loop of henle","Proximal tubule","Proximal tubule S3",
                "Podocytes","Endothelial I cells","Immune cells",
                "Other or unknown"))
samples <- transform(samples,cell_label = x)
topic_colors <- c("orange","darkmagenta","magenta","gold","peru",
                  "red","lightgray","limegreen","dodgerblue","royalblue")
p1 <- structure_plot(fit,grouping = samples$cell_label,gap = 20,
                     colors = topic_colors,verbose = FALSE)
print(p1)
```

```{r structure-plot-for-paper-1, echo=FALSE}
ggsave("plots/structure_plot_by_cell_label_cusanovich_kidney.eps",p1,
       height = 2.25,width = 9)
```

Let's now visualize the topics without the benefit of the previously
inferred clusters. Instead, we can use PCs computed from the topic
proportions to subdivide the cells into 5 clusters. (Here we are
assigning labels to these clusters only to make it easier to refer to
them.)

```{r clusters-from-topics}
pca <- prcomp(fit$L)$x
pc1 <- pca[,1]
pc2 <- pca[,2]
x <- rep("other",nrow(pca))
x[pc1 < 0] <- "proximal tubule"
x[pc1 > 0 & pc2 > 0.2] <- "endothelial I"
rows <- which(x == "other")
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("DCT + CD",nrow(pca))
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc1 < 0 & pc2 > -0.15] <- "loop of henle"
y[pc1 >= 0 & pc2 > -0.15] <- "podocytes + other"
x[rows] <- y
samples$cluster <- factor(x,c("DCT + CD","loop of henle","proximal tubule",
                              "podocytes + other","endothelial I"))
```

This is what the Structure plot looks like without any external
grouping of the cells:

```{r structure-plot-2, fig.height=2.5, fig.width=8, message=FALSE}
set.seed(1)
p2 <- structure_plot(fit,grouping = samples$cluster,gap = 20,
                     colors = topic_colors,verbose = FALSE)
print(p2)
```

The topics clearly identify four distinctive cell types—(1) loop of
henle, (2) proximal tubule, (3) distal convoluted tubule (DCT) and
collecting duct (CD), and (4) endothelial cells—and within these
distinctive cell types there is sometimes a good amount of continuous
variation in expression that is further captured by the topics, such
as the two topics for DCT and CD, and the heterogeneity among the
proximal tubule cells captured by several topics.

```{r structure-plot-for-paper-2, echo=FALSE}
ggsave("plots/structure_plot_by_cluster_cusanovich_kidney.eps",p2,
       height = 2,width = 9)
```

Next, let's see if the gene ranking generated from the differential
accessibility analysis of the topics supports these interpretations,
and helps us interpret some of the other topics that are less clear
such as topic 9.

In this next code chunk we prepare the `gene_info` and `de_gene` data
structures for the volcano plots.

```{r prepare-de-gene}
data(gene_sets_mouse)
gene_info <- gene_sets_mouse$gene_info
gene_info <- subset(gene_info,!is.na(Ensembl))
gene_info <- subset(gene_info,!duplicated(Ensembl))
ids <- gene_info$Ensembl
ids <- intersect(ids,rownames(de_gene$coef))
de_gene$coef  <- de_gene$coef[ids,]
de_gene$logLR <- de_gene$logLR[ids,]
ids       <- rownames(de_gene$coef)
gene_info <- subset(gene_info,is.element(Ensembl,ids))
rownames(gene_info) <- gene_info$Ensembl
gene_info <- gene_info[ids,]
genes     <- gene_info$Symbol
```

*Add text here.*

```{r volcano-plots-1, fig.height=13, fig.width=8, warning=FALSE}
k <- 2
label_genes <- (is.element(genes,cd_genes) & de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 35 & de_gene$coef[,k] > 0) |
               (de_gene$coef[,k] > 3)
k2_genes <- genes
k2_genes[!label_genes] <- ""
p2 <- volcano_plot_enrich(de_gene,k = 2,labels = k2_genes,
                          highlight = is.element(genes,cd_genes),
                          ymax = 100)
k <- 5
label_genes <- (is.element(genes,dct_genes) & de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 40 & de_gene$coef[,k] > 1) |
               (de_gene$coef[,k] > 3)
k5_genes <- genes
k5_genes[!label_genes] <- ""
p5 <- volcano_plot_enrich(de_gene,k = 5,labels = k5_genes,
                          highlight = is.element(genes,dct_genes),
                          ymax = 100)
k <- 3
label_genes <- (is.element(genes,endo_genes) & de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 85 & de_gene$coef[,k] > 2.25) |
               (de_gene$coef[,k] > 4.5)
k3_genes <- genes
k3_genes[!label_genes] <- ""
p3 <- volcano_plot_enrich(de_gene,k = 3,labels = k3_genes,
                          highlight = is.element(genes,endo_genes),
                          ymax = 125)
k <- 1
label_genes <- (is.element(genes,podo_genes) & de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 50 & de_gene$coef[,k] > 2) |
               (de_gene$logLR[,k] > 20 & de_gene$coef[,k] > 3.75)
k1_genes <- genes
k1_genes[!label_genes] <- ""
p1 <- volcano_plot_enrich(de_gene,k = 1,labels = k1_genes,
                          highlight = is.element(genes,podo_genes),
                          ymax = 80)
k <- 8
label_genes <- (is.element(genes,loh_genes) & de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 60 & de_gene$coef[,k] > 0) |
               (de_gene$coef[,k] > 3)
k8_genes <- genes
k8_genes[!label_genes] <- ""
p8 <- volcano_plot_enrich(de_gene,k = 8,labels = k8_genes,
                          highlight = is.element(genes,loh_genes),
                          ymax = 140)
plot_grid(p2,p5,
          p3,p1,
          p8,
          nrow = 3,ncol = 2)
```

*Add text here.*

```{r volcano-plots-2, fig.width=8, fig.height=4.5, warning=FALSE}
k <- 9
label_genes <- (is.element(genes,c(pt_genes,S1_genes)) &
                de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 100 & de_gene$coef[,k] > 1) |
               (de_gene$coef[,k] > 3)
k9_genes <- genes
k9_genes[!label_genes] <- ""
k9_highlight <- rep(0,length(genes))
k9_highlight[is.element(genes,pt_genes)] <- 1
k9_highlight[is.element(genes,S1_genes)] <- 2
p9 <- volcano_plot_enrich(de_gene,k = 9,labels = k9_genes,
                          highlight = factor(k9_highlight),ymax = 200)
k <- 10
label_genes <- (is.element(genes,c(pt_genes,S3_genes)) &
                de_gene$logLR[,k] > 4) |
               (de_gene$logLR[,k] > 65 & de_gene$coef[,k] > 1.5) |
               (de_gene$coef[,k] > 3)
k10_genes <- genes
k10_genes[!label_genes] <- ""
k10_highlight <- rep(0,length(genes))
k10_highlight[is.element(genes,pt_genes)] <- 1
k10_highlight[is.element(genes,S3_genes)] <- 2
p10 <- volcano_plot_enrich(de_gene,k = 10,labels = k10_genes,
                           highlight = factor(k10_highlight),ymax = 200)
plot_grid(p9,p10,nrow = 1,ncol = 2)
```

To do:

+ Put together the Structure plots for the paper.

+ Change x-axis label in volcano plots.

+ Compile enrichment results into tables.

+ Create volcano plots for remaining topics.

+ Put together the volcano plots for paper.

```{r volcano-plots-3, fig.width=8, fig.height=3, warning=FALSE}
# Add remaining volcano plots here.
```

Diagram from [osmosis.com](https://www.osmosis.org):

![kidney diagram](kidney.jpg)
