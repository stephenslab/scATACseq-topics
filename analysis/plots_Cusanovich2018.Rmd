---
title: "Visualize topics in Cusanovich2018 data"
author: "Kaixuan Luo"
output: workflowr::wflow_html
---

Here we examine and compare the topic modeling results for the 
scATAC-seq dataset from the mouse single-cell atlas paper 
[Cusanovich *et al* (2018)](scATACseq_data_Cusanovich2018.html)

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that will be used to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(Matrix)
library(tools)
library(dplyr)
library(ggplot2)
library(cowplot)
library(mapplots)
source("code/plots.R")
```

Cusanovich 2018 mouse scATAC-seq data in all 13 tissues
=======================================================

Load the data
```{r load-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Cusanovich_2018/processed_data/"
load(file.path(data.dir, "Cusanovich_2018.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
range(colSums(counts))
rm(counts)
```

About the samples:
The study measured single cell chromatin accessibility for 17 samples 
spanning 13 different tissues in 8-week old mice.

```{r samples}
cat(nrow(samples), "samples (cells). \n")
```

Tissues:
```{r samples-tissues}
samples$tissue <- as.factor(samples$tissue)
cat(length(levels(samples$tissue)), "tissues. \n")
table(samples$tissue)
```

Cell types labels:
```{r samples-cells}
samples$cell_label <- as.factor(samples$cell_label)
cat(length(levels(samples$cell_label)), "cell types \n")
table(samples$cell_label)
```

The structure plots below summarize the topic proportions in the samples grouped by different tissues.

$k = 13$: 
```{r load-fit}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-scd-ex-k=13.rds"))$fit
samples$tissue <- as.factor(samples$tissue)
```

## Visualize by Structure plot grouped by tissues
```{r structure-plot-full-data, fig.width=8, fig.height=2.5, message=FALSE}
set.seed(1)
topic_colors <- c("gold","royalblue","red","sienna","limegreen",
                  "plum","tomato","purple","cyan","forestgreen",
                  "darkblue","darkorange","lightgray")
topics <- c(1,2,5,6,9,11,4,10,8,3,7,12,13)

p.structure <- structure_plot(fit,grouping = samples$tissue,gap = 30,n = 4000,
                     perplexity = 30,topics = topics,colors = topic_colors,
                     verbose = FALSE)

print(p.structure)
```


Plot samples by tissues on the t-SNE coordinates provided by the original paper:

```{r tSNE, fig.width=7, fig.height=5}
colors_tissues <- c("BoneMarrow" = "darkblue",
                    "Lung" = "lightblue",
                    "Thymus" = "orange",
                    "Spleen" = "pink",
                    "Liver" = "purple",
                    "Testes" = "yellow",
                    "SmallIntestine" = "darkgreen",
                    "LargeIntestine" = "brown",
                    "Kidney" = "green",
                    "Heart" = "red",
                    "WholeBrain" = "gray",
                    "PreFrontalCortex" = "black",
                    "Cerebellum" = "darkgray")

colors_tissues <- colors_tissues[order(names(colors_tissues))]
dat <- samples[, c("tsne_1", "tsne_2", "tissue")]

ggplot(dat, aes(x = tsne_1, y = tsne_2, colour=tissue)) + 
      geom_point(size = 0.5, na.rm = TRUE) + 
      scale_colour_manual(values=colors_tissues) +
      labs(x = 't-SNE 1', y = 't-SNE 2', title = '') + 
      theme_cowplot()
```


```{r topic-membership-pies-tSNE-1, include = FALSE, eval= FALSE, fig.width=5, fig.height=5}
# Visualize topic membership using pie-charts on t-SNE coordinates
# Visualize topic membership using pie-charts for cells on t-SNE coordinates provided by the original paper
# Plot the subset of 2000 samples
idx_selected_samples <- sample(nrow(fit$L),2000)

plot(NA,NA, main = paste("K = 13"), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_selected_samples, function(r)
  add.pie(z=as.integer(100*fit_multinom$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = topic_colors))
```

Zoom into a few tissues
========================

PreFrontalCortex
----------------

Load the data
```{r load-PreFrontalCortex-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Cusanovich_2018/processed_data"
load(file.path(data.dir, "Cusanovich_2018_PreFrontalCortex.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
range(colSums(counts))
rm(counts)
```

Cell types labels:
```{r PreFrontalCortex-samples-cells}
cat(nrow(samples), "samples (cells). \n")

samples$cell_label <- as.factor(samples$cell_label)
cat(length(levels(samples$cell_label)), "cell types \n")
table(samples$cell_label)

cat("cell type groups: \n")
samples$cell_group <- as.character(samples$cell_label)
samples$cell_group[grep("Endothelial", samples$cell_group)] <- "Endothelial cells"
samples$cell_group[grep("Interneurons", samples$cell_group)] <- "Interneurons"
samples$cell_group[samples$cell_group %in% names(which(table(samples$cell_group) <= 5))] <- "Others"
table(samples$cell_group)

samples$cell_group <- factor(samples$cell_group, levels = c("Ex. neurons CPN", "Ex. neurons CThPN", "Ex. neurons SCPN",
                                                            "Inhibitory neurons", "Interneurons", 
                                                            "Astrocytes", "Oligodendrocytes",
                                                            "Macrophages", "Microglia", "Podocytes",
                                                            "Collisions", "Others",  "Unknown"))
```

The structure plots below summarize the topic proportions in the samples grouped by different cell labels.

$k = 7$
```{r PreFrontalCortex-structure-plot-k7, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-PreFrontalCortex-scd-ex-k=7.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,
                              grouping = samples$cell_group,
                              n = 4000, gap = 40, perplexity = 50,
                              topics = 1:7, num_threads = 6,verbose = FALSE)

print(p.structure)
```

$k = 8$
```{r PreFrontalCortex-structure-plot-k8, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-PreFrontalCortex-scd-ex-k=8.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,
                              grouping = samples$cell_group,
                              n = 4000, gap = 40, perplexity = 50,
                              topics = 1:8, num_threads = 6,verbose = FALSE)

print(p.structure)
```

$k = 9$
```{r PreFrontalCortex-structure-plot-k9, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-PreFrontalCortex-scd-ex-k=9.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,grouping = samples$cell_group,
                              gap = 30,n = 4000, perplexity = 30,
                              topics = 1:9, colors = topic_colors, verbose = FALSE)

print(p.structure)
```
$k = 10$
```{r PreFrontalCortex-structure-plot-k10, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-PreFrontalCortex-scd-ex-k=10.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,grouping = samples$cell_group,
                              gap = 30,n = 4000, perplexity = 30,
                              topics = 1:10, colors = topic_colors, verbose = FALSE)

print(p.structure)
```

Kidney
------

Load the data
```{r load-Kidney-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Cusanovich_2018/processed_data/"
load(file.path(data.dir, "Cusanovich_2018_Kidney.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
range(colSums(counts))
rm(counts)
```

Cell types labels:
```{r Kidney-samples-cells}
cat(nrow(samples), "samples (cells). \n")

samples$cell_label <- as.factor(samples$cell_label)
cat(length(levels(samples$cell_label)), "cell types \n")
table(samples$cell_label)

samples$cell_group <- as.character(samples$cell_label)
samples$cell_group[grep("Endothelial", samples$cell_group)] <- "Endothelial cells"
samples$cell_group[grep("T cells", samples$cell_group)] <- "T cells"
samples$cell_group[grep("B cells", samples$cell_group)] <- "B cells"
samples$cell_group[grep("DCT/CD", samples$cell_group)] <- "Distal convoluted tubule/Collecting duct"
samples$cell_group[samples$cell_group %in% names(which(table(samples$cell_group) <= 5))] <- "Others"
table(samples$cell_group)

samples$cell_group <- factor(samples$cell_group, levels = c("Podocytes", "Proximal tubule", "Proximal tubule S3", 
                                                            "Loop of henle", "Distal convoluted tubule", 
                                                            "Distal convoluted tubule/Collecting duct",
                                                            "Collecting duct", "Endothelial cells",
                                                            "Others", "Unknown"))

```

The structure plots below summarize the topic proportions in the samples grouped by different cell labels.

$k = 7$
```{r Kidney-structure-plot-k7, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-Kidney-scd-ex-k=7.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,grouping = samples$cell_group,
                              gap = 30,n = 4000, perplexity = 30,
                              topics = 1:7, colors = topic_colors, verbose = FALSE)

print(p.structure)
```

$k = 8$
```{r Kidney-structure-plot-k8, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-Kidney-scd-ex-k=8.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,grouping = samples$cell_group,
                              gap = 30,n = 4000, perplexity = 30,
                              topics = 1:8, colors = topic_colors, verbose = FALSE)

print(p.structure)
```

$k = 9$
```{r Kidney-structure-plot-k9, fig.width=8, fig.height=2.5, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-Kidney-scd-ex-k=9.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,grouping = samples$cell_group,
                              gap = 30,n = 4000, perplexity = 30,
                              topics = 1:9, colors = topic_colors, verbose = FALSE)

print(p.structure)
```
$k = 10$
```{r Kidney-structure-plot-k10, fig.width=8, fig.height=3, message=FALSE}
fit.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018/tissues"
fit <- readRDS(file.path(fit.dir, "/fit-Cusanovich2018-Kidney-scd-ex-k=10.rds"))$fit

set.seed(1)

p.structure <- structure_plot(fit,grouping = samples$cell_group,
                              gap = 30,n = 4000, perplexity = 30,
                              topics = 1:10, colors = topic_colors, verbose = FALSE)

print(p.structure)
```
