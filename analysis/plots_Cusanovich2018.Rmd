---
title: "Visualize and interpret topics in Cusanovich2018 data"
author: "Kaixuan Luo"
output: workflowr::wflow_html
---

Here we examine and compare the topic modeling results for the 
scATAC-seq dataset from the mouse single-cell atlas paper 
[Cusanovich *et al* (2018)](scATACseq_data_Cusanovich2018.html)

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that will be used to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(tools)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(mapplots)
source("code/plots.R")
```

```{r}
set.seed(1)
```

Cusanovich 2018 mouse scATAC-seq dataset
------------------------------------------

### Load the data and Poisson NMF model fit
Load the data
```{r load-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Cusanovich_2018/processed_data/"
load(file.path(data.dir, "Cusanovich_2018.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
rm(counts)
```

About the samples:
The study measured single cell chromatin accessibility for 17 samples 
spanning 13 different tissues in 8-week old mice.

```{r samples}
cat(nrow(samples), "samples (cells). \n")
```

Tissues:
```{r samples-tissues}
samples$tissue <- as.factor(samples$tissue)
cat(length(levels(samples$tissue)), "tissues. \n")
table(samples$tissue)

```

Cell types labels:
```{r samples-cells}
samples$cell_label <- as.factor(samples$cell_label)
cat(length(levels(samples$cell_label)), "cell types \n")
table(samples$cell_label)

```

Load the results of running `fit_poisson_nmf` on the Cusanovich2018 data,
with different algorithms, and for various choices of $k$ (the number
of "topics").
```{r load-PoissonNMF-fit}
out.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Cusanovich_2018"
load(file.path(out.dir, "/compiled.fits.Cusanovich2018.RData"))

```

Select all `scd-ex` model fits
```{r}
fits <- fits[grep("scd-ex", names(fits))]
```

### Structure plots

The structure plots below summarize the topic proportions in the samples grouped by different tissues.

$k = 2$: 
```{r structure-plot-2, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=2"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 3$: 
```{r structure-plot-3, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=3"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 4$: 
```{r structure-plot-4, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=4"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 5$: 
```{r structure-plot-5, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=5"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 6$: 
```{r structure-plot-6, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=6"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 7$: 
```{r structure-plot-7, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=7"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 8$: 
```{r structure-plot-8, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=8"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 9$: 
```{r structure-plot-9, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=9"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

$k = 10$: 
```{r structure-plot-10, fig.width=7, fig.height=2}
fit_poisson_nmf <- fits[["fit-Cusanovich2018-scd-ex-k=10"]]

p.structure_plot <- structure_plot(poisson2multinom(fit_poisson_nmf),
                     grouping = samples[,"tissue"],
                     n = 2000,gap = 40,num_threads = 4,verbose = FALSE)
print(p.structure_plot)
```

### t-SNE plot

Plot samples by tissues on the t-SNE coordinates provided by the original paper:
```{r tSNE-tissues, fig.width=7, fig.height=5}
p.tissues_tsne <- ggplot(samples, aes(x = tsne_1, y = tsne_2)) + 
  geom_point(aes(colour = tissue), size = 0.5) + 
  labs(x = 't-SNE 1', y = 't-SNE 2', title = '') + 
  scale_color_discrete('') +
  theme_classic()

print(p.tissues_tsne)
```

Plot a random subset of 2000 samples by tissues:
```{r tSNE-tissues-2, fig.width=7, fig.height=5}
idx_plot <- sort(sample(1:length(samples$cell), 2000))

p.tissues_tsne <- ggplot(samples[idx_plot,], aes(x = tsne_1, y = tsne_2)) + 
  geom_point(aes(colour = tissue), size = 0.5) + 
  labs(x = 't-SNE 1', y = 't-SNE 2', title = '') + 
  scale_color_discrete('') +
  theme_classic()

print(p.tissues_tsne)
```

### Visualize topic membership using pie-charts on t-SNE coordinates

Visualize topic membership using pie-charts for cells on t-SNE coordinates provided by the original paper

Plot the subset of 2000 samples:

$k = 3$: 
```{r topic-membership-pies-tSNE-1, fig.width=5, fig.height=5}
k <- 3
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 4$: 
```{r topic-membership-pies-tSNE-2, fig.width=5, fig.height=5}
k <- 4
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 5$: 
```{r topic-membership-pies-tSNE-3, fig.width=5, fig.height=5}
k <- 5
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 6$: 
```{r topic-membership-pies-tSNE-4, fig.width=5, fig.height=5}
k <- 6
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 7$: 
```{r topic-membership-pies-tSNE-5, fig.width=5, fig.height=5}
k <- 7
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 8$: 
```{r topic-membership-pies-tSNE-6, fig.width=5, fig.height=5}
k <- 8
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 9$: 
```{r topic-membership-pies-tSNE-7, fig.width=5, fig.height=5}
k <- 9
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```

$k = 10$: 
```{r topic-membership-pies-tSNE-8, fig.width=5, fig.height=5}
k <- 10
fit_poisson_nmf <- fits[[sprintf("fit-Cusanovich2018-scd-ex-k=%d", k)]]
fit <- poisson2multinom(fit_poisson_nmf)

plot(NA,NA, main = paste("K =", k), 
     xlab = 't-SNE 1', ylab = 't-SNE 2', 
     xlim=c(min(samples$tsne_1),max(samples$tsne_1)),
     ylim=c(min(samples$tsne_2),max(samples$tsne_2)))

res <- lapply(idx_plot, function(r)
  add.pie(z=as.integer(100*fit$L[r,]),
          x=samples[r,"tsne_1"],
          y=samples[r,"tsne_2"], labels=c("","",""),
          radius = 1, col = RColorBrewer::brewer.pal(9, "Set1")))
```
