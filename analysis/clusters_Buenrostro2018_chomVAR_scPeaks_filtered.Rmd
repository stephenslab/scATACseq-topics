---
title: "Clustering Buenrostro *et al* (2018) scATAC-seq data using topic proportions"
author: Kaixuan Luo
output:
  workflowr::wflow_html:
    toc: yes
---

Here we explore the structure in the Buenrostro *et al* (2018) 
scATAC-seq data inferred from the 
multinomial topic model with $k = 11$.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```
					  
Load packages and some functions used in this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(ggplot2)
library(cowplot)
library(fastTopics)
source("code/plots.R")
```

We applied the analysis both **unbinarized** counts and **binarized** scATAC-seq data.

## Unbinarized counts
Load the **unbinarized** data
```{r load-unbinarized-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Buenrostro_2018/processed_data_Chen2019pipeline/chromVAR/"
load(file.path(data.dir, "Buenrostro_2018_scPeaks_filtered.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
rm(counts)
samples$cell <- rownames(samples)
samples$label <- as.factor(samples$label)

```

### Plot PCs of the topic proportions
We first use PCA to explore the structure inferred from the
multinomial topic model with $k = 11$:

```{r load-unbinarized-fit}
out.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Buenrostro_2018_chromVAR_scPeaks/unbinarized/"
fit <- readRDS(file.path(out.dir, "/fit-Buenrostro2018-scd-ex-k=11.rds"))$fit

colors_topics <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c",
                   "#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99")
```

Plot PCs of the topic proportions.

```{r pca-unbinarized-1, fig.width=7, fig.height=4.5}
p.pca1.1 <- pca_plot(poisson2multinom(fit),pcs = 1:2,fill = "none")
p.pca1.2 <- pca_plot(poisson2multinom(fit),pcs = 3:4,fill = "none")
p.pca1.3 <- pca_plot(poisson2multinom(fit),pcs = 5:6,fill = "none")
p.pca1.4 <- pca_plot(poisson2multinom(fit),pcs = 7:8,fill = "none")
p.pca1.5 <- pca_plot(poisson2multinom(fit),pcs = 9:10,fill = "none")

plot_grid(p.pca1.1,p.pca1.2,p.pca1.3,p.pca1.4,p.pca1.5)
```

Some of the structure is more evident from “hexbin” plots 
showing the density of the points.

```{r pca-unbinarized-2, fig.width=7, fig.height=4.5}
breaks <- c(0,1,5,10,100,Inf)
p.pca2.1 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 1:2, breaks = breaks) + guides(fill = "none")
p.pca2.2 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 3:4, breaks = breaks) + guides(fill = "none")
p.pca2.3 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 5:6, breaks = breaks) + guides(fill = "none")
p.pca2.4 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 7:8, breaks = breaks) + guides(fill = "none")
p.pca2.5 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 9:10, breaks = breaks) + guides(fill = "none")

plot_grid(p.pca2.1,p.pca2.2,p.pca2.3,p.pca2.4,p.pca2.5)
```

### Layer the cell labels onto the PC plots
Here, we layer the cell labels onto the PC plots.

```{r pca-unbinarized-3, fig.width=9, fig.height=5}
p.pca3.1 <- labeled_pca_plot(fit,1:2,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.2 <- labeled_pca_plot(fit,3:4,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.3 <- labeled_pca_plot(fit,5:6,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.4 <- labeled_pca_plot(fit,7:8,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.5 <- labeled_pca_plot(fit,9:10,samples$label,font_size = 7,
                       legend_label = "Cell labels")
plot_grid(p.pca3.1,p.pca3.2,p.pca3.3,p.pca3.4,p.pca3.5)
```

Visualize by structure plot grouped by cell labels.
```{r structure-plot-unbinarized-1, fig.width=7, fig.height=3}
set.seed(10)

samples$label <- as.factor(samples$label)

p.structure.1 <- structure_plot(poisson2multinom(fit),
                     grouping = samples[, "label"],n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)

print(p.structure.1)
```

### k-means clustering on topic proportions
Define clusters using k-means, and then create structure plot 
based on the clusters from k-means.

Define clusters using k-means with 10 clusters:
```{r kmeans-unbinarized-1}
set.seed(10)

clusters.10 <- factor(kmeans(poisson2multinom(fit)$L,centers = 10)$cluster)
print(sort(table(clusters.10),decreasing = TRUE))
```

Structure plot based on k-means clusters
```{r structure-plot-kmeans-unbinarized-1, fig.width=7, fig.height=3}
p.structure.2 <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.10,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.2)
```

Define clusters using k-means with 15 clusters:
```{r kmeans-unbinarized-2}
set.seed(10)

clusters.15 <- factor(kmeans(poisson2multinom(fit)$L,centers = 15)$cluster)
print(sort(table(clusters.15),decreasing = TRUE))
```

Structure plot based on k-means clusters
```{r structure-plot-kmeans-unbinarized-2, fig.width=7, fig.height=3}
p.structure.3 <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.15,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11, colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.3)
```

Define clusters using k-means with 20 clusters:
```{r kmeans-unbinarized-3}
set.seed(10)

clusters.20 <- factor(kmeans(poisson2multinom(fit)$L,centers = 20)$cluster)
print(sort(table(clusters.20),decreasing = TRUE))
```

Structure plot based on k-means clusters
```{r structure-plot-kmeans-unbinarized-3, fig.width=7, fig.height=3}
p.structure.4 <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.20,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11, colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.4)
```

### Refine clusters
We then further refine the clusters based on k-means result with 20 clusters:
merge clusters 3, 4;
merge clusters 5, 6, 8, 19;
merge clusters 14 and 18.
```{r refine-cluster-unbinarized-1}
clusters.merged <- clusters.20
clusters.merged[clusters.20 %in% c(3,4)] <- 3
clusters.merged[clusters.20 %in% c(5,6,8,19)] <- 5
clusters.merged[clusters.20 %in% c(14,18)] <- 14

clusters.merged <- factor(clusters.merged, labels = paste0("c", c(1:length(unique(clusters.merged)))))
samples$cluster_kmeans <- clusters.merged
table(clusters.merged)
```

```{r refine-cluster-unbinarized-2, fig.width=7, fig.height=3}
p.structure.refined <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.merged,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.refined)
```

Group samples by k-means clusters first, then by celltype labels: 
```{r refine-cluster-unbinarized-3, fig.width=7, fig.height=3}
p.structure.refined <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.merged,
                     rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.refined)
```

The clusters defined by k-means on topic proportions
reasonably identify the clusters shown in the PCA hexbin plots (below).

```{r pca-kmeans-unbinarized-1, fig.width=9, fig.height=4.5}
p.pca.4.1 <- labeled_pca_plot(fit,1:2,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.2 <- labeled_pca_plot(fit,3:4,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.3 <- labeled_pca_plot(fit,5:6,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.4 <- labeled_pca_plot(fit,7:8,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.5 <- labeled_pca_plot(fit,9:10,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
plot_grid(p.pca.4.1,p.pca.4.2,p.pca.4.3,p.pca.4.4,p.pca.4.5)
```

```{r pca-kmeans-unbinarized-2, fig.width=7, fig.height=4.5}
plot_grid(p.pca2.1,p.pca2.2,p.pca2.3,p.pca2.4,p.pca2.5)

```

We then label the cells in each cluster with the known cell labels.

Cell labels:
```{r samples-cells-unbinarized}
samples$label <- as.factor(samples$label)
cat(length(levels(samples$label)), "cell labels. \n")
table(samples$label)

```

We can see a few clusters are dominated by one major cell type: 

```{r freq-cluster-cells-unbinarized}
freq_cluster_cells <- with(samples,table(label,cluster_kmeans))
print(freq_cluster_cells)
```

Plot the distribution of cell labels by clusters.

Stacked barplot for the counts of cell labels by clusters:
```{r freq-cluster-cell-unbinarized-1, fig.width=8, fig.height=3}
library(plyr);library(dplyr)
library(RColorBrewer)

freq_cluster_celltype <- count(samples, vars=c("cluster_kmeans","label"))
n_colors <- length(levels(samples$label))
colors_labels <- brewer.pal(10, "Set3")

# stacked barplot for the counts of cell labels by clusters
p.barplot.1 <- ggplot(freq_cluster_celltype, aes(fill=label, y=freq, x=cluster_kmeans)) + 
  geom_bar(position="stack", stat="identity") +
  theme_classic() + xlab("Cluster") + ylab("Number of cells") +
  scale_fill_manual(values = colors_labels) +
  guides(fill=guide_legend(ncol=2)) +
  theme(
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8)
  )
print(p.barplot.1)

```

Percent stacked barplot for the counts of cell labels by clusters:
```{r freq-cluster-tissue-unbinarized-2, fig.width=8, fig.height=3}

freq_cluster_celltype <- count(samples, vars=c("cluster_kmeans","label")) 
n_colors <- length(levels(samples$label))
colors_labels <- brewer.pal(10, "Set3")

p.barplot.2 <- ggplot(freq_cluster_celltype, aes(fill=label, y=freq, x=cluster_kmeans)) + 
  geom_bar(position="fill", stat="identity") +
  theme_classic() + xlab("Cluster") + ylab("Proportion of cells") +
  scale_fill_manual(values = colors_labels) +
  guides(fill=guide_legend(ncol=2)) +
  theme(
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8)
  )
print(p.barplot.2)

```







## Binarized counts
Load the **binarized** data
```{r load-binarized-data}
data.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/data/Buenrostro_2018/processed_data_Chen2019pipeline/chromVAR/"
load(file.path(data.dir, "Buenrostro_2018_binarized_scPeaks_filtered.RData"))
cat(sprintf("%d x %d counts matrix.\n",nrow(counts),ncol(counts)))
rm(counts)
samples$cell <- rownames(samples)
samples$label <- as.factor(samples$label)
```

### Plot PCs of the topic proportions
We first use PCA to explore the structure inferred from the
multinomial topic model with $k = 11$:

```{r load-binarized-fit}
out.dir <- "/project2/mstephens/kevinluo/scATACseq-topics/output/Buenrostro_2018_chromVAR_scPeaks_filtered/binarized/"
fit <- readRDS(file.path(out.dir, "/fit-Buenrostro2018-binarized-scd-ex-k=11.rds"))$fit

colors_topics <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c",
                   "#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99")
```

Plot PCs of the topic proportions.

```{r pca-binarized-1, fig.width=7, fig.height=4.5}
p.pca1.1 <- pca_plot(poisson2multinom(fit),pcs = 1:2,fill = "none")
p.pca1.2 <- pca_plot(poisson2multinom(fit),pcs = 3:4,fill = "none")
p.pca1.3 <- pca_plot(poisson2multinom(fit),pcs = 5:6,fill = "none")
p.pca1.4 <- pca_plot(poisson2multinom(fit),pcs = 7:8,fill = "none")
p.pca1.5 <- pca_plot(poisson2multinom(fit),pcs = 9:10,fill = "none")

plot_grid(p.pca1.1,p.pca1.2,p.pca1.3,p.pca1.4,p.pca1.5)
```

Some of the structure is more evident from “hexbin” plots 
showing the density of the points.

```{r pca-binarized-2, fig.width=7, fig.height=4.5}
breaks <- c(0,1,5,10,100,Inf)
p.pca2.1 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 1:2, breaks = breaks) + guides(fill = "none")
p.pca2.2 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 3:4, breaks = breaks) + guides(fill = "none")
p.pca2.3 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 5:6, breaks = breaks) + guides(fill = "none")
p.pca2.4 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 7:8, breaks = breaks) + guides(fill = "none")
p.pca2.5 <- pca_hexbin_plot(poisson2multinom(fit), pcs = 9:10, breaks = breaks) + guides(fill = "none")

plot_grid(p.pca2.1,p.pca2.2,p.pca2.3,p.pca2.4,p.pca2.5)
```

### Layer the cell labels onto the PC plots
Here, we layer the cell labels onto the PC plots.

```{r pca-binarized-3, fig.width=9, fig.height=5}
p.pca3.1 <- labeled_pca_plot(fit,1:2,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.2 <- labeled_pca_plot(fit,3:4,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.3 <- labeled_pca_plot(fit,5:6,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.4 <- labeled_pca_plot(fit,7:8,samples$label,font_size = 7,
                       legend_label = "Cell labels")
p.pca3.5 <- labeled_pca_plot(fit,9:10,samples$label,font_size = 7,
                       legend_label = "Cell labels")

plot_grid(p.pca3.1,p.pca3.2,p.pca3.3,p.pca3.4,p.pca3.5)
```

Visualize by structure plot grouped by cell labels.
```{r structure-plot-binarized-1, fig.width=7, fig.height=3}
set.seed(10)

samples$label <- as.factor(samples$label)

p.structure.1 <- structure_plot(poisson2multinom(fit),
                     grouping = samples[, "label"], 
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)

print(p.structure.1)
```

### k-means clustering on topic proportions
Define clusters using k-means, and then create structure plot 
based on the clusters from k-means.

Define clusters using k-means with 10 clusters:
```{r kmeans-binarized-1}
set.seed(10)

clusters.10 <- factor(kmeans(poisson2multinom(fit)$L,centers = 10)$cluster)
print(sort(table(clusters.10),decreasing = TRUE))
```

Structure plot based on k-means clusters
```{r structure-plot-kmeans-binarized-1, fig.width=7, fig.height=3}
p.structure.2 <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.10,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.2)
```

Define clusters using k-means with 15 clusters:
```{r kmeans-binarized-2}
set.seed(10)

clusters.15 <- factor(kmeans(poisson2multinom(fit)$L,centers = 15)$cluster)
print(sort(table(clusters.15),decreasing = TRUE))
```

Structure plot based on k-means clusters
```{r structure-plot-kmeans-binarized-2, fig.width=7, fig.height=3}
p.structure.3 <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.15,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11, colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.3)
```

Define clusters using k-means with 20 clusters:
```{r kmeans-binarized-3}
set.seed(10)

clusters.20 <- factor(kmeans(poisson2multinom(fit)$L,centers = 20)$cluster)
print(sort(table(clusters.20),decreasing = TRUE))
```

Structure plot based on k-means clusters
```{r structure-plot-kmeans-binarized-3, fig.width=7, fig.height=3}
p.structure.4 <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.20,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11, colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.4)
```

### Refine clusters
We then further refine the clusters based on k-means result with 20 clusters:
merge clusters 5 and 8.

```{r refine-cluster-binarized-1}
clusters.merged <- clusters.20
clusters.merged[clusters.20 %in% c(5,8)] <- 5

clusters.merged <- factor(clusters.merged, labels = paste0("c", c(1:length(unique(clusters.merged)))))
samples$cluster_kmeans <- clusters.merged
table(clusters.merged)
```

```{r refine-cluster-binarized-2, fig.width=7, fig.height=3}
p.structure.refined <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.merged,
                     # rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.refined)
```

Group samples by k-means clusters first, then by celltype labels: 
```{r refine-cluster-binarized-3, fig.width=7, fig.height=3}
p.structure.refined <- structure_plot(poisson2multinom(fit),
                     grouping = clusters.merged,
                     rows = order(samples$label), # samples are grouped by clusters first, then by celltype labels
                     n = Inf,gap = 20,
                     perplexity = 50,topics = 1:11,colors = colors_topics,
                     num_threads = 4,verbose = FALSE)
print(p.structure.refined)
```

The clusters defined by k-means on topic proportions
reasonably identify the clusters shown in the PCA hexbin plots (below).

```{r pca-kmeans-binarized-1, fig.width=9, fig.height=4.5}
p.pca.4.1 <- labeled_pca_plot(fit,1:2,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.2 <- labeled_pca_plot(fit,3:4,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.3 <- labeled_pca_plot(fit,5:6,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.4 <- labeled_pca_plot(fit,7:8,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
p.pca.4.5 <- labeled_pca_plot(fit,9:10,samples$cluster_kmeans,font_size = 7,
                       legend_label = "cluster_kmeans")
plot_grid(p.pca.4.1,p.pca.4.2,p.pca.4.3,p.pca.4.4,p.pca.4.5)
```

```{r pca-kmeans-binarized-2, fig.width=7, fig.height=4.5}
plot_grid(p.pca2.1,p.pca2.2,p.pca2.3,p.pca2.4,p.pca2.5)

```

We then label the cells in each cluster with the known cell labels.

Cell labels:
```{r samples-cells-binarized}
samples$label <- as.factor(samples$label)
cat(length(levels(samples$label)), "cell labels. \n")
table(samples$label)

```

We can see a few clusters are dominated by one major cell type: 

```{r freq-cluster-cells-binarized}
freq_cluster_cells <- with(samples,table(label,cluster_kmeans))
print(freq_cluster_cells)
```

Plot the distribution of cell labels by clusters.

Stacked barplot for the counts of cell labels by clusters:
```{r freq-cluster-cell-binarized-1, fig.width=8, fig.height=3}
library(plyr);library(dplyr)
library(RColorBrewer)

freq_cluster_celltype <- count(samples, vars=c("cluster_kmeans","label"))
n_colors <- length(levels(samples$label))
colors_labels <- brewer.pal(10, "Set3")

# stacked barplot for the counts of cell labels by clusters
p.barplot.1 <- ggplot(freq_cluster_celltype, aes(fill=label, y=freq, x=cluster_kmeans)) + 
  geom_bar(position="stack", stat="identity") +
  theme_classic() + xlab("Cluster") + ylab("Number of cells") +
  scale_fill_manual(values = colors_labels) +
  guides(fill=guide_legend(ncol=2)) +
  theme(
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8)
  )
print(p.barplot.1)

```

Percent stacked barplot for the counts of cell labels by clusters:
```{r freq-cluster-tissue-binarized-2, fig.width=8, fig.height=3}

freq_cluster_celltype <- count(samples, vars=c("cluster_kmeans","label")) 
n_colors <- length(levels(samples$label))
colors_labels <- brewer.pal(10, "Set3")

p.barplot.2 <- ggplot(freq_cluster_celltype, aes(fill=label, y=freq, x=cluster_kmeans)) + 
  geom_bar(position="fill", stat="identity") +
  theme_classic() + xlab("Cluster") + ylab("Proportion of cells") +
  scale_fill_manual(values = colors_labels) +
  guides(fill=guide_legend(ncol=2)) +
  theme(
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8)
  )
print(p.barplot.2)

```





